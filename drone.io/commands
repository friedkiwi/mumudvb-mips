export PATH="${PATH}:/home/ubuntu/src/github.com/Gorkhaan/mumudvb-mips/x-tools/mips-unknown-linux-uclibc/bin"
cd /home/ubuntu/src/github.com/Gorkhaan/mumudvb-mips

mkdir artifacts

rm -rf dvb-apps-src
mkdir dvb-apps-src
wget "http://linuxtv.org/hg/dvb-apps/archive/tip.tar.gz" -O dvb-apps-src.tar.gz
tar -xzf dvb-apps-src.tar.gz -C dvb-apps-src --strip-components=1


rm -rf libdvbcsa-src
svn co svn://svn.videolan.org/libdvbcsa/trunk libdvbcsa
mv libdvbcsa libdvbcsa-src


rm -rf MuMuDVB
git clone https://github.com/braice/MuMuDVB.git


cd /home/ubuntu/src/github.com/Gorkhaan/mumudvb-mips


# Compiling dvb-apps/lib
cd /home/ubuntu/src/github.com/Gorkhaan/mumudvb-mips
cd dvb-apps-src/lib
make CC=mips-unknown-linux-uclibc-gcc
find . -type f -name "*.so*" -exec cp {} /home/ubuntu/src/github.com/Gorkhaan/mumudvb-mips/x-tools/mips-unknown-linux-uclibc/mips-unknown-linux-uclibc/lib/ \;
find ../include/ -type f -exec cp {} /home/ubuntu/src/github.com/Gorkhaan/mumudvb-mips/x-tools/mips-unknown-linux-uclibc/mips-unknown-linux-uclibc/include/ \;
cp -ra * /home/ubuntu/src/github.com/Gorkhaan/mumudvb-mips/x-tools/mips-unknown-linux-uclibc/mips-unknown-linux-uclibc/include/


# Compiling libdvbcsa
cd /home/ubuntu/src/github.com/Gorkhaan/mumudvb-mips
cd libdvbcsa-src
autoreconf -i -f
./configure --host=mips-unknown-linux-uclibc --prefix=/home/ubuntu/src/github.com/Gorkhaan/mumudvb-mips/libdvbcsa-src
make
make install
find lib/ -type f -name "*.so*" -exec cp {} /home/ubuntu/src/github.com/Gorkhaan/mumudvb-mips/x-tools/mips-unknown-linux-uclibc/mips-unknown-linux-uclibc/lib/ \;
cp -ra include/* /home/ubuntu/src/github.com/Gorkhaan/mumudvb-mips/x-tools/mips-unknown-linux-uclibc/mips-unknown-linux-uclibc/include/
mv /home/ubuntu/src/github.com/Gorkhaan/mumudvb-mips/x-tools/mips-unknown-linux-uclibc/mips-unknown-linux-uclibc/lib/libdvbcsa.so.1.0.1 /home/ubuntu/src/github.com/Gorkhaan/mumudvb-mips/x-tools/mips-unknown-linux-uclibc/mips-unknown-linux-uclibc/lib/libdvbcsa.so


# Compiling MuMuDVB
cd /home/ubuntu/src/github.com/Gorkhaan/mumudvb-mips
cd MuMuDVB
autoreconf -i -f

./configure --host mips-unknown-linux-uclibc
make CC="mips-unknown-linux-uclibc-gcc -std=gnu99"
cp src/mumudvb /home/ubuntu/src/github.com/Gorkhaan/mumudvb-mips/artifacts/mumudvb-mips

# Collecting and tuning files
cd /home/ubuntu/src/github.com/Gorkhaan/mumudvb-mips

cp x-tools/mips-unknown-linux-uclibc/mips-unknown-linux-uclibc/lib/libdvbcsa.so artifacts/libdvbcsa.so.1
cp x-tools/mips-unknown-linux-uclibc/mips-unknown-linux-uclibc/lib/libdvben50221.so artifacts/libdvben50221.so
cp x-tools/mips-unknown-linux-uclibc/mips-unknown-linux-uclibc/lib/libucsi.so artifacts/libucsi.so
cp x-tools/mips-unknown-linux-uclibc/mips-unknown-linux-uclibc/lib/libdvbapi.so artifacts/libdvbapi.so


# Building mpc85xx OpenWRT package with ipkg-build script
cd /home/ubuntu/src/github.com/Gorkhaan/mumudvb-mips

mkdir opkgsrc
mkdir opkgsrc/CONTROL
mkdir opkgsrc/usr
mkdir opkgsrc/usr/bin
mkdir opkgsrc/lib

cp artifacts/libdvbcsa.so.1 opkgsrc/lib/
cp artifacts/libdvben50221.so opkgsrc/lib/
cp artifacts/libucsi.so opkgsrc/lib/
cp artifacts/libdvbapi.so opkgsrc/lib/
cp artifacts/mumudvb-mips opkgsrc/usr/bin/

cat << 'EOT' > opkgsrc/CONTROL/control
Package: mumudvb-mips
Version: 1.0.0-1
Depends: librt
License: None
Maintainer: Dorian OCSOVSZKI <gorkhaan@gmail.com>
Architecture: ar71xx
Description:  MuMuDVB-MIPS built with CAM and SCAM support
 Please check this site for latest updates:
 https://github.com/Gorkhaan/mumudvb-mips
EOT

cp opkg/ipkg-build /home/ubuntu/src/github.com/Gorkhaan/mumudvb-mips

bash ipkg-build opkgsrc .

cp mumudvb-mips_1.0.0-1_ar71xx.ipk artifacts/

